/*
 *@project: Fishing competition
 *@author: Qin Xu
 *@date: 6/9/2019
 *@description: map page
*/

<!DOCTYPE html>
<html>
<head>
    <title>Competition Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/5.10.0/firebase.js"></script>
    <script src="../js/fireBase.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyACSvwEYu8nhcsb3tubvu8NOObIbBQ4gB8"></script>
    <meta charset="utf-8">
    <link rel="icon" type="image/png" href="../image/map.png">
    <style>
        #map {
            height: 100%;
        }

        html,
        body {
            height: 100%;
            /* height: 80%; */
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script>
        //initialize the database
        var database = firebase.database();
        var ref = database.ref();
        console.log("Access the database!");
        //read data
        ref.on("value", gotData, errData);
        var key = getQueryString("id");
        console.log(key);

        function gotData(data) {
            var competitions = data.child('Competitions').val();
            var keys = Object.keys(competitions);
            var geodata = competitions[key].geo_map;
            var attendants = competitions[key].attendants;
            var status = competitions[key].cStatus;
            console.log(typeof geodata);
            var lat = Number(geodata.split(",")[0]);
            var lng = Number(geodata.split(",")[1]);
            var rad = Number(geodata.split(',')[2])*1000;

            //set parameters for the map
            var map;
            map = new google.maps.Map(document.getElementById('map'), {
                center: {
                    lat: lat,
                    lng: lng
                },              
                zoom: 15,
                maxZoom: 17,
                minZoom: 13,
                scaleControl: true
            });

            //set parameters for the competition area
            var compCircle = {
                strokeColor: "#f1c40f",
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: "#f1c40f",
                fillOpacity: 0.35,
                map: map,
                center: new google.maps.LatLng(lat, lng),
                radius: rad // in meters  
            };
            drawCircle = new google.maps.Circle(compCircle);

            //display the markers in the competition time
            if (status == 1) {
                var refDatabase = firebase.database().ref();
                refDatabase.once("value").then(function (snapshot) {
                    for (uid in attendants) {
                        //get data
                        var refUser = snapshot.child('Users');
                        var refGPS = snapshot.child('Live_GPS');
                        var refPost = snapshot.child('Posts/Competitions/' + key);
                        var latitude = refGPS.child(attendants[uid]).child('latitude').val();
                        var longitude = refGPS.child(attendants[uid]).child('longitude').val();
                        var name = refUser.child(attendants[uid]).child('displayName').val();
                        //get the list of posts
                        var posts = refPost.val();              
                        //get the user's latest post's url 
                        var url = '#';
                        if (posts != null) {
                            var keys = Object.keys(posts);
                            for (var i = keys.length - 1; i >= 0; i--) {
                                if (keys[i].split("_")[1] ==
                                    attendants[uid]) {
                                    url = posts[keys[i]].oriDownloadUrl;
                                    break;
                                }
                            }
                        }

                        //add marker to the map
                        var marker = new google.maps.Marker({
                            map: map,
                            position: new google.maps.LatLng(Number(latitude),
                                 Number(longitude)),
                        });
                        attachMessage(marker, url, name);
                    }
                })
            }
        }
        
        // attath the infowindow to the marker
        function attachMessage(marker, url, name) {
            if (url == '#') {
                //is the user has not posted post
                //add user name to the infowindow
                var infowindow = new google.maps.InfoWindow({
                    content: name
                });
            } else {
                //add latest post to the infowindow
                var infowindow = new google.maps.InfoWindow({
                    content: "<img src=" + url + " width=200px>" + "<br>" + 
                        'Photo by: '+name
                });
            }
            //bind a click listner
            marker.addListener('click', function () {
                infowindow.open(marker.get('map'), marker);
            });
        }

        function errData(err) {
            console.log('Error!');
            console.log(err);
        }

        //split the string
        function getQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]);
            return null;
        }
    </script>

</body>

</html>